<!doctype html>

<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cart & Checkout</title>
<style>
  :root {
    --bg: #faf9f6;
    --dust-rose: #D6A7A1;
    --olive-gold: #C2B280;
    --muted: #666;
    --card: #fff;
  }
  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    background: var(--bg);
    color: #222;
  }
  .wrap {
    width: 100%;
    margin: 0;
    padding: 24px;
  }
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 18px;
  }
  header h1 { font-size: 24px; margin: 0; }

.cartbox {
background: var(--card);
padding: 20px;
border-radius: 10px;
box-shadow: 0 1px 6px rgba(0,0,0,0.04);
}
input, select, textarea {
width: 100%;
padding: 14px;
font-size: 16px;
border: 1px solid #ccc;
border-radius: 6px;
}
textarea { resize: vertical; }
label.small { display: block; margin-bottom: 6px; font-size: 13px; color: #444; }
.btn {
background: var(--dust-rose);
color: #fff;
border: 0;
padding: 10px 14px;
border-radius: 8px;
cursor: pointer;
font-size: 15px;
box-shadow: 0 3px 6px rgba(0,0,0,0.08);
}
.btn:hover { background: var(--olive-gold); transform: scale(1.02); }
.ghost { background: #fff; color: #333; border: 1px solid #ddd; }
.mini { padding: 8px 10px; font-size: 14px; }
.thank {
background: #eaf7eb;
border-radius: 8px;
padding: 18px;
margin-top: 12px;
display: none;
}
.muted { color: var(--muted); font-size: 13px; }
.total-row { display: flex; justify-content: space-between; font-weight: 700; }
.summary { border-top: 1px dashed #eee; margin-top: 10px; padding-top: 10px; }
.cart-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding: 8px 0; } </style>

</head>
<body>
  <div class="wrap">
    <header><h1>Your Cart</h1>
    </header>

<div class="cartbox">
  <div id="cartItemsContainer" class="cart-items"></div>

  <div class="summary">
    <div>Subtotal <span id="subtotalText" style="float:right">Rs. 0</span></div>
    <div>Delivery <span id="deliveryText" style="float:right">Rs. 0</span></div>
    <div class="total-row">Total <span id="totalText">Rs. 0</span></div>
  </div>

   <div style="margin-top:8px">
        <button id="checkoutBtn" class="btn" style="width:100%">Proceed to Checkout</button>
      </div>

      <div style="margin-top:12px">
        <button id="clearCartBtn" class="btn ghost" style="width:100%">Clear cart</button>
      </div>
      <div style="margin-top:12px">
  <button id="continueShoppingBtn" class="btn ghost" style="width:100%">← Continue Shopping</button>
</div>

  <form id="checkoutForm" style="display:none;margin-top:15px">
    <div>Please provide your details *</div>

    <div><input name="email" type="email" placeholder="Email Address *" required><style="margin-top:10px;"></div>
    <div><input name="firstName" type="text" placeholder="First Name *" required><style="margin-top:10px;"></div>
    <div><input name="middleName" type="text" placeholder="Middle Name (optional)"><style="margin-top:10px;"></div>
    <div><input name="lastName" type="text" placeholder="Last Name *" required><style="margin-top:10px;"></div>
    <div><input name="phone" type="tel" placeholder="Phone Number *" required><style="margin-top:10px;"></div>
    <div><input name="address" rows="2" placeholder="Address Line 1 *" required><style="margin-top:10px;"></div>
    <div><input name="city" type="text" placeholder="City / Town *" required><style="margin-top:10px;"></div>
    <div><input name="state" type="text" placeholder="State / Country *" required><style="margin-top:10px;"></div>
    <div><input name="zip" type="text" placeholder="Zip / Postal (optional)"><style="margin-top:10px;"></div>

    <div style="margin-top:10px">
          <label class="small">Payment method *</label>
          <select name="paymentMethod" required style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px">
            <option value="">-- Select --</option>
            <option value="cod">Cash on Delivery (COD)</option>
    </select>
    </div>

   <div style="margin-top:10px">
          <button type="submit" class="btn" style="width:100%">Place Order</button>
        </div>
      </form>

  <div id="thankYou" class="thank">
    <h3>Thank you — your order is received</h3>
    <p>We’ll contact you soon for confirmation.</p>
    </div>
 </div>
</div>

<script>

/* -------- CONFIG: edit these after deploy -------- */
const deliveryCharge = 250;
const webhookUrl = "https://mia-proxy-29rq1lvji-mias-projects-3a54d5c3.vercel.app/api/proxy";
const webhookSecret = "MIA_ORGANIC_SECRET";
/* ------------------------------------------------ */

function formatPKR(n){ return 'Rs. ' + Number(n).toFixed(0); }

/* --- CART --- */
let cart = JSON.parse(localStorage.getItem('store_cart') || '[]');

function saveCart() {
  localStorage.setItem('store_cart', JSON.stringify(cart));
  renderCart();
}

/* add from URL params if present (e.g. ?add=Oat%20%26%20Honey%20Soap&price=550&id=p1) */
function addProductFromUrl() {
  const params = new URLSearchParams(window.location.search);
  const name = params.get('add');
  const priceRaw = params.get('price');
  const id = params.get('id') || null;
  if (name && priceRaw) {
    const price = parseFloat(priceRaw);
    if (!isNaN(price)) {
      const existing = cart.find(i => (id && i.id===id) || i.name === name);
      if (existing) existing.qty += 1;
      else cart.push({ id, name: decodeURIComponent(name), price: price, qty: 1 });
      saveCart();
      // remove params so refresh doesn't add again
      history.replaceState(null,'', window.location.pathname);
    }
  }
}

function renderCart() {
  const cartItemsContainer = document.getElementById('cartItemsContainer');
  cartItemsContainer.innerHTML = '';
  if (cart.length === 0) {
    cartItemsContainer.innerHTML = '<div class="muted">Your cart is empty.</div>';
    document.getElementById('subtotalText').innerText = formatPKR(0);
    document.getElementById('deliveryText').innerText = formatPKR(0);
    document.getElementById('totalText').innerText = formatPKR(0);
    return;
  }

  let subtotal = 0;
  cart.forEach((item, idx) => {
    const itemTotal = item.price * item.qty;
    subtotal += itemTotal;
    const row = document.createElement('div');
    row.className = 'cart-row';
    row.innerHTML = `
      <div class="label">
        <div><strong>${item.name}</strong></div>
        <div class="muted">${formatPKR(item.price)} × ${item.qty}</div>
      </div>
      <div style="text-align:right">
        <div>${formatPKR(itemTotal)}</div>
        <div style="margin-top:6px">
          <button class="ghost mini" onclick="decreaseQty(${idx})" style="margin-right:6px">−</button>
          <button class="ghost mini" onclick="increaseQty(${idx})">+</button>
          <div style="height:6px"></div>
          <button class="ghost mini" onclick="removeItem(${idx})" style="margin-top:6px">Remove</button>
        </div>
      </div>
    `;
    cartItemsContainer.appendChild(row);
  });

  document.getElementById('subtotalText').innerText = formatPKR(subtotal);
  document.getElementById('deliveryText').innerText = formatPKR(deliveryCharge);
  document.getElementById('totalText').innerText = formatPKR(subtotal + deliveryCharge);
}

function increaseQty(i){ cart[i].qty++; saveCart(); }
function decreaseQty(i){ if(cart[i].qty>1) cart[i].qty--; else cart.splice(i,1); saveCart(); }
function removeItem(i){ cart.splice(i,1); saveCart(); }

/* buttons */
document.addEventListener('DOMContentLoaded', () => {
  addProductFromUrl();
  renderCart();

  document.getElementById('clearCartBtn').addEventListener('click', () => {
    if(!confirm('Clear cart?')) return; 
    then(removeAllItems)
    cart = []; saveCart();
  });

  document.getElementById('continueShoppingBtn').addEventListener('click', () => {
  // Go back if there is a history
  if (window.history.length > 1) {
    window.history.back();
  } else {
    // Fallback: send them to your shop page
    window.location.href = "https://sites.google.com/view/miaorganic/shop-online";
  }
});

  document.getElementById('checkoutBtn').addEventListener('click', () => {
    if(cart.length===0){ alert('Your cart is empty.'); return; }
    document.getElementById('checkoutForm').style.display = 'block';
    document.getElementById('checkoutBtn').scrollIntoView({behavior:'smooth',block:'center'});
  });


});
    
/* ORDER / checkout handling */
function collectOrderData(form){
  const f=n=>form.querySelector(`[name="${n}"]`)?.value||"";
  const customer={email:f("email"),firstName:f("firstName"),middleName:f("middleName"),lastName:f("lastName"),phone:f("phone"),address:f("address"),city:f("city"),state:f("state"),zip:f("zip"),paymentMethod:f("paymentMethod")};
  const items=cart.map(i=>`${i.name} x${i.qty} (${i.price})`).join(" | ");
  const subtotal=cart.reduce((s,it)=>s+it.price*it.qty,0);
  return { 
  ...customer,
  items,
  subtotal,
  deliveryCharge,
  total:subtotal+deliveryCharge, 
  createdAt:new Date().toISOString() };
}

document.getElementById('checkoutForm').addEventListener('submit',async e=>{
  e.preventDefault();
  if(cart.length===0)return alert('Cart is empty');
  const order=collectOrderData(e.target);

// Optional: POST to webhook (if you configure webhookUrl above)
  if(webhookUrl && webhookUrl.length>5){
    try {
      await fetch(webhookUrl, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ secret: webhookSecret, order })
      });
    } catch(err){
      console.warn('Webhook send failed', err);
    }
  }

  // Clear cart and show thank you

  cart=[];saveCart();
  document.getElementById('checkoutForm').style.display='none';
  document.getElementById('thankYou').style.display='block';
});
</script>

</body>
</html>





